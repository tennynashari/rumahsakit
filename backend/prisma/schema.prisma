// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  email     String   @unique @db.VarChar(100)
  password  String
  role      Role     @default(PATIENT)
  department String? @db.VarChar(100)
  phone     String?  @db.VarChar(30)
  avatarUrl String?  @map("avatar_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  doctorVisits    Visit[]         @relation("DoctorVisits")
  medicalRecords  MedicalRecord[]
  auditLogs       AuditLog[]

  @@map("users")
}

model Patient {
  id               Int      @id @default(autoincrement())
  medicalRecordNo  String   @unique @map("medical_record_no") @db.VarChar(20)
  name             String   @db.VarChar(100)
  dateOfBirth      DateTime @map("date_of_birth") @db.Date
  gender           Gender
  phone            String?  @db.VarChar(20)
  address          String?  @db.Text
  emergencyContact Json?    @map("emergency_contact")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  visits         Visit[]
  medicalRecords MedicalRecord[]
  billings       Billing[]

  @@map("patients")
}

model Visit {
  id          Int         @id @default(autoincrement())
  patientId   Int         @map("patient_id")
  doctorId    Int         @map("doctor_id")
  visitType   VisitType   @map("visit_type")
  scheduledAt DateTime    @map("scheduled_at")
  queueNumber String?     @map("queue_number") @db.VarChar(20)
  status      VisitStatus @default(SCHEDULED)
  notes       String?     @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  patient        Patient         @relation(fields: [patientId], references: [id])
  doctor         User            @relation("DoctorVisits", fields: [doctorId], references: [id])
  medicalRecords MedicalRecord[]
  billings       Billing[]

  @@map("visits")
}

model MedicalRecord {
  id            Int      @id @default(autoincrement())
  visitId       Int?     @map("visit_id")
  patientId     Int      @map("patient_id")
  doctorId      Int      @map("doctor_id")
  diagnosisCode String?  @map("diagnosis_code") @db.VarChar(20)
  symptoms      String?  @db.Text
  diagnosis     String?  @db.Text
  treatment     String?  @db.Text
  prescription  Json?
  attachments   Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  visit   Visit?  @relation(fields: [visitId], references: [id])
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  User    @relation(fields: [doctorId], references: [id])

  @@map("medical_records")
}

model Medicine {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(150)
  description String?  @db.Text
  unit        String   @db.VarChar(50)
  price       Decimal  @db.Decimal(12, 2)
  supplierId  Int?     @map("supplier_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  batches MedicineBatch[]

  @@map("medicines")
}

model MedicineBatch {
  id         Int      @id @default(autoincrement())
  medicineId Int      @map("medicine_id")
  batchNo    String   @map("batch_no") @db.VarChar(50)
  stock      Int      @default(0)
  expiryDate DateTime @map("expiry_date") @db.Date
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  medicine Medicine @relation(fields: [medicineId], references: [id])

  @@unique([medicineId, batchNo])
  @@map("medicine_batches")
}

model Room {
  id          Int        @id @default(autoincrement())
  roomNumber  String     @unique @map("room_number") @db.VarChar(20)
  roomType    RoomType   @map("room_type")
  capacity    Int        @default(1)
  pricePerDay Decimal    @map("price_per_day") @db.Decimal(12, 2)
  status      RoomStatus @default(AVAILABLE)
  floor       Int?
  description String?    @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@map("rooms")
}

model Billing {
  id        Int           @id @default(autoincrement())
  patientId Int           @map("patient_id")
  visitId   Int?          @map("visit_id")
  items     Json // Array of billing items
  subtotal  Decimal       @db.Decimal(12, 2)
  tax       Decimal       @default(0) @db.Decimal(12, 2)
  discount  Decimal       @default(0) @db.Decimal(12, 2)
  total     Decimal       @db.Decimal(12, 2)
  status    BillingStatus @default(UNPAID)
  paidAt    DateTime?     @map("paid_at")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])
  visit   Visit?  @relation(fields: [visitId], references: [id])

  @@map("billings")
}

model AuditLog {
  id       Int      @id @default(autoincrement())
  userId   Int?     @map("user_id")
  action   String   @db.VarChar(50)
  entity   String   @db.VarChar(50)
  entityId Int?     @map("entity_id")
  oldData  Json?    @map("old_data")
  newData  Json?    @map("new_data")
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// Enums
enum Role {
  ADMIN
  DOCTOR
  NURSE
  FRONT_DESK
  PHARMACY
  LABORATORY
  PATIENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum VisitType {
  GENERAL_CHECKUP
  OUTPATIENT
  INPATIENT
  EMERGENCY
}

enum VisitStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum RoomType {
  SINGLE
  DOUBLE
  TRIPLE
  ICU
  EMERGENCY
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

enum BillingStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  CANCELLED
}